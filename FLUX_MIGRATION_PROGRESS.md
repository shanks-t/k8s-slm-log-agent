# Flux GitOps Migration Progress

**Branch:** `agent/flux`
**Started:** 2025-12-27
**Status:** In Progress
**Goal:** Migrate K3S homelab from imperative to declarative Flux-based GitOps

---

## Migration Overview

This document tracks all progress, decisions, and blockers during the migration from imperative Kubernetes management to Flux GitOps. Reference: [infra-roadmap.md](./infra-roadmap.md)

---

## Progress Summary

| Step | Description | Status | Completion Date | Notes |
|------|-------------|--------|-----------------|-------|
| 1 | Inventory Existing Cluster | ðŸŸ¡ In Progress | - | Creating inventory directory structure |
| 2 | Export Current State | âšª Not Started | - | |
| 3 | Clean and Normalize | âšª Not Started | - | |
| 4 | Define Repository Structure | âšª Not Started | - | |
| 5 | Convert Helm to HelmReleases | âšª Not Started | - | |
| 6 | Secret Management Strategy | âšª Not Started | - | |
| 7 | Bootstrap Flux | âšª Not Started | - | |
| 8 | Configure Reconciliation | âšª Not Started | - | |
| 9 | Incremental Migration | âšª Not Started | - | |
| 10 | Validate Rebuild | âšª Not Started | - | |

**Legend:** âšª Not Started | ðŸŸ¡ In Progress | ðŸŸ¢ Complete | ðŸ”´ Blocked

---

## Detailed Progress Log

### 2025-12-27: Migration Kickoff

#### Session 1: Setup and Planning

**Actions Taken:**
- Created FLUX_MIGRATION_PROGRESS.md for tracking
- Reviewed existing repository structure
- Identified current state:
  - Platform resources in `platform/` (o11y, gateway, crds)
  - Workload manifests in `workloads/` (llama-cpp, log-analyzer)
  - No existing Flux infrastructure

**Current Cluster State (Pre-Migration):**
- **Cluster:** K3S two-node homelab
  - Node 1 (control plane): hardware=light
  - Node 2 (worker): hardware=heavy
- **Namespaces:**
  - `logging` (Loki, Grafana, Tempo, Alloy)
  - `envoy-gateway-system` (Envoy Gateway)
  - `llm` (llama.cpp)
  - `log-analyzer` (FastAPI service)
- **Helm Releases (5):**
  - Loki, Grafana, Tempo, Alloy (in logging)
  - Envoy Gateway (in envoy-gateway-system)
- **YAML Workloads (2):**
  - llama-cpp (Deployment, Service, PV, PVC)
  - log-analyzer (Deployment, Service, ConfigMap)

**Next Steps:**
- Begin Step 1: Inventory cluster state
- Create `inventory/` directory with comprehensive exports

---

## Decisions Made

### Decision Log

| Date | Decision | Rationale | Impact |
|------|----------|-----------|--------|
| 2025-12-27 | Use private Git repo for secrets initially | Homelab setup, acceptable risk, can migrate to SOPS later | Faster bootstrap, clear upgrade path |
| 2025-12-27 | Pin all Helm chart versions | Prevent unexpected updates, controlled upgrades | Stability, reproducibility |

---

## Blockers and Issues

### Active Blockers

*None currently*

### Resolved Issues

*None yet*

### Known Risks

| Risk | Mitigation | Status |
|------|------------|--------|
| K3S-specific features may not translate directly | Document all imperative changes (Envoy proxy, storage) | Monitoring |
| PersistentVolumes require manual setup | Document PV creation as pre-bootstrap step | Monitoring |
| Helm release ownership conflicts | Uninstall old releases before Flux takes over | Planned |

---

## Technical Notes

### Repository Structure Changes

**Current Structure:**
```
k8s-slm-log-agent/
â”œâ”€â”€ platform/          # Platform resources (not Flux-structured)
â”‚   â”œâ”€â”€ o11y/          # Loki, Grafana, Tempo values
â”‚   â”œâ”€â”€ gateway/       # Envoy Gateway config
â”‚   â””â”€â”€ crds/          # Custom Resource Definitions
â”œâ”€â”€ workloads/         # Application workloads
â”‚   â”œâ”€â”€ llama-cpp/
â”‚   â””â”€â”€ log-analyzer/
â””â”€â”€ docs/
```

**Target Flux Structure (from roadmap):**
```
k8s-slm-log-agent/
â”œâ”€â”€ clusters/
â”‚   â””â”€â”€ homelab/
â”‚       â”œâ”€â”€ flux-system/           # Auto-generated by Flux bootstrap
â”‚       â”œâ”€â”€ infrastructure.yaml    # Root kustomization for infra
â”‚       â””â”€â”€ workloads.yaml         # Root kustomization for apps
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ sources/                   # HelmRepositories
â”‚   â”œâ”€â”€ controllers/               # Envoy Gateway
â”‚   â”œâ”€â”€ logging/                   # Loki, Grafana, Tempo, Alloy
â”‚   â””â”€â”€ storage/                   # PersistentVolumes
â”œâ”€â”€ workloads/
â”‚   â”œâ”€â”€ llm/                       # llama-cpp
â”‚   â””â”€â”€ log-analyzer/              # FastAPI service
â””â”€â”€ scripts/                       # Helper scripts
```

### K3S-Specific Considerations

1. **Storage:** K3S uses local-path provisioner by default
   - Need to explicitly create PVs for Node 2 NVMe storage
   - Path: `/mnt/k8s-storage/`
2. **Traefik:** Disabled in favor of Envoy Gateway
   - Ensure Flux doesn't re-enable it
3. **ServiceLB:** K3S built-in load balancer
   - No changes needed, Flux compatible
4. **VXLAN:** UDP port 8472 open for cross-node networking
   - Document as prerequisite

---

## Validation Checklist

### Pre-Migration Validation

- [ ] All Helm releases listed: `helm list -A`
- [ ] All deployments captured: `kubectl get deploy,sts,ds -A`
- [ ] All PVs/PVCs documented: `kubectl get pv,pvc -A`
- [ ] All services exported: `kubectl get svc -A`
- [ ] All CRDs identified: `kubectl get crd`
- [ ] Helm values extracted for all releases

### Post-Migration Validation

- [ ] Flux controllers healthy: `flux check`
- [ ] All HelmReleases reconciled: `flux get helmreleases -A`
- [ ] All Kustomizations applied: `flux get kustomizations`
- [ ] All pods running: `kubectl get pods -A`
- [ ] Grafana accessible via Envoy Gateway
- [ ] Log-analyzer service functional
- [ ] LLM inference working
- [ ] Drift prevention tested (manual edit â†’ Flux reverts)

### Rebuild Validation

- [ ] Cluster wiped and reinstalled
- [ ] Flux bootstrapped from Git alone
- [ ] All resources reconciled automatically
- [ ] All services functional
- [ ] Rebuild time < 20 minutes

---

## Commands Reference

### Inventory Commands (Step 1)

```bash
# Create inventory directory
mkdir -p inventory

# List all namespaces
kubectl get namespaces -o name > inventory/namespaces.txt

# List all Helm releases
helm list -A -o yaml > inventory/helm-releases.yaml

# Export Helm values
helm get values eg -n envoy-gateway-system > inventory/helm-values-envoy-gateway.yaml
helm get values alloy -n logging > inventory/helm-values-alloy.yaml
helm get values grafana -n logging > inventory/helm-values-grafana.yaml
helm get values loki -n logging > inventory/helm-values-loki.yaml
helm get values tempo -n logging > inventory/helm-values-tempo.yaml

# List all workloads
kubectl get deployments,statefulsets,daemonsets -A -o yaml > inventory/workloads.yaml

# List all services
kubectl get services -A -o yaml > inventory/services.yaml

# List all PVs and PVCs
kubectl get pv,pvc -A -o yaml > inventory/storage.yaml

# List all CRDs
kubectl get crd -o name > inventory/crds.txt

# List all storage classes
kubectl get storageclass -o yaml > inventory/storageclasses.yaml
```

### Flux Bootstrap Command (Step 7)

```bash
# Set environment variables
export GITHUB_USER=your-github-username
export GITHUB_TOKEN=ghp_your_personal_access_token
export GITHUB_REPO=k8s-slm-log-agent

# Bootstrap Flux
flux bootstrap github \
  --owner=$GITHUB_USER \
  --repository=$GITHUB_REPO \
  --branch=agent/flux \
  --path=clusters/homelab \
  --personal \
  --components-extra=image-reflector-controller,image-automation-controller
```

---

## Git Commits Log

All commits follow conventional commit format:

### Commits Made

*No commits yet - migration in progress*

---

## Next Session Agenda

1. Complete Step 1: Inventory cluster
   - Run all inventory commands
   - Validate exports are complete
   - Commit to Git: `feat(flux): add cluster state inventory`

2. Begin Step 2: Export current state
   - Create `exports/` directory structure
   - Export all resources as YAML
   - Commit to Git: `feat(flux): export current cluster state`

---

## Resources and References

- [Flux Documentation](https://fluxcd.io/flux/)
- [infra-roadmap.md](./infra-roadmap.md) - Detailed migration plan
- [agents.md](./agents.md) - System architecture overview
- [K3S Documentation](https://docs.k3s.io/)

---

**Last Updated:** 2025-12-27
**Next Review:** After completing Step 1 (Inventory)
