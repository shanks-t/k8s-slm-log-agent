# Grafana Helm Chart Values
# Chart: grafana/grafana
# Purpose: Web UI for exploring logs from Loki
# Deployment: Single pod on Node 1

# Admin credentials
# IMPORTANT: Change these in production!
adminUser: admin
adminPassword: admin  # TODO: Change this!

# Persistence for dashboards and configuration
# Disabled for simplicity - dashboards will be ephemeral
# Enable this if you want dashboards to survive pod restarts
persistence:
  enabled: false
  # size: 10Gi
  # storageClassName: local-storage

# Pre-configure Loki and Tempo as datasources
# This automatically adds both when Grafana starts
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Loki
        type: loki
        access: proxy
        # Loki service URL (internal Kubernetes DNS)
        url: http://loki.logging.svc.cluster.local:3100
        # Make this the default datasource
        isDefault: true
        jsonData:
          # Max lines to fetch from Loki
          maxLines: 1000
          # Enable derived fields for trace correlation
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: "trace_id=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"
        # No authentication needed for internal cluster communication
        editable: true

      - name: Tempo
        type: tempo
        access: proxy
        # Tempo service URL (internal Kubernetes DNS)
        url: http://tempo.logging.svc.cluster.local:3200
        jsonData:
          # Enable trace to logs correlation
          tracesToLogs:
            datasourceUid: loki
            tags: ['job', 'instance', 'pod', 'namespace']
            mappedTags: [{ key: 'service.name', value: 'service' }]
            mapTagNamesEnabled: false
            spanStartTimeShift: '1h'
            spanEndTimeShift: '1h'
            filterByTraceID: false
            filterBySpanID: false
          # Enable service graph
          serviceMap:
            datasourceUid: 'prometheus'  # We'll add Prometheus later
          nodeGraph:
            enabled: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: loki
        uid: tempo
        editable: true

# Service configuration
service:
  type: ClusterIP  # Internal only - we'll expose via Envoy Gateway
  port: 80
  targetPort: 3000

# Resources for Grafana pod
resources:
  requests:
    cpu: 100m      # 0.1 CPU cores
    memory: 128Mi  # 128MB RAM
  limits:
    cpu: 500m      # Max 0.5 CPU cores
    memory: 512Mi  # Max 512MB RAM

# Node placement - run on Node 1
nodeSelector:
  hardware: light

# Grafana doesn't need to tolerate the taint - it runs on node-1

# Environment variables
env:
  # Set timezone
  TZ: America/Chicago

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 472  # Grafana default user
  fsGroup: 472

# Disable unnecessary features for homelab
# This reduces resource usage
grafana.ini:
  analytics:
    check_for_updates: false
    reporting_enabled: false

  # Anonymous access disabled - require login
  auth.anonymous:
    enabled: false

  # Server configuration
  server:
    root_url: "%(protocol)s://%(domain)s/grafana"
    serve_from_sub_path: true

  # Logging
  log:
    mode: console
    level: info

# Plugins to install (none needed for basic Loki usage)
plugins: []

# Dashboard providers (none pre-configured)
# You'll create dashboards through the UI
dashboardProviders: {}
dashboards: {}
